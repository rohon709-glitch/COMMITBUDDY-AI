import streamlit as st
import requests

# =========================
# OLLAMA CONFIG
# =========================
OLLAMA_URL = "http://localhost:11434/api/generate"
MODEL = "phi3"   # fast & stable

def call_llm(prompt):
    try:
        payload = {
            "model": MODEL,
            "prompt": prompt,
            "stream": False
        }
        res = requests.post(OLLAMA_URL, json=payload, timeout=60)
        res.raise_for_status()
        return res.json()["response"]
    except Exception as e:
        return f"‚ùå Error: {e}"

# =========================
# STREAMLIT CONFIG
# =========================
st.set_page_config(
    page_title="CommitBuddy AI",
    page_icon="ü•ó",
    layout="wide"
)

st.title("ü•ó CommitBuddy AI")
st.caption("Personalized Nutrition & Commitment Assistant")

# =========================
# TABS (MATCHING YOUR FORMAT)
# =========================
tab1, tab2, tab3 = st.tabs([
    "Basic Information",
    "Health Details",
    "Preferences & Lifestyle"
])

# =========================
# TAB 1 ‚Äî BASIC INFO
# =========================
with tab1:
    age = st.number_input("Age", min_value=1, max_value=120, value=30)

    gender = st.selectbox(
        "Gender",
        ["Male", "Female", "Non-binary / Other"]
    )

    height = st.text_input("Height", "5'10\"")
    weight = st.text_input("Weight", "160 lbs")

    activity_level = st.select_slider(
        "Activity Level",
        options=[
            "Sedentary",
            "Lightly Active",
            "Moderately Active",
            "Very Active",
            "Extremely Active"
        ]
    )

    goals = st.multiselect(
        "Goals",
        [
            "Weight Loss",
            "Weight Gain",
            "Muscle Building",
            "Maintenance",
            "General Health"
        ]
    )

# =========================
# TAB 2 ‚Äî HEALTH DETAILS
# =========================
with tab2:
    medical_conditions = st.text_area(
        "Medical Conditions",
        placeholder="e.g. Diabetes, BP, Thyroid"
    )

    medications = st.text_area(
        "Medications",
        placeholder="List any medications"
    )

    allergies = st.text_area(
        "Allergies",
        placeholder="Food allergies or intolerances"
    )

# =========================
# TAB 3 ‚Äî PREFERENCES
# =========================
with tab3:
    food_preferences = st.text_area(
        "Food Preferences",
        placeholder="Vegetarian, Non-veg, Vegan, etc."
    )

    cooking_ability = st.select_slider(
        "Cooking Ability",
        options=["Very Limited", "Basic", "Average", "Advanced"]
    )

    budget = st.select_slider(
        "Budget",
        options=["Very Limited", "Moderate", "Flexible"]
    )

    cultural_factors = st.text_area(
        "Cultural / Religious Factors",
        placeholder="Any dietary restrictions"
    )

# =========================
# GENERATE PLAN
# =========================
st.divider()

if st.button("Generate Nutrition Plan"):
    with st.spinner("CommitBuddy AI is working..."):
        prompt = f"""
Create a personalized nutrition plan.

Age: {age}
Gender: {gender}
Height: {height}
Weight: {weight}
Activity Level: {activity_level}
Goals: {', '.join(goals) if goals else 'General Health'}

Medical Conditions: {medical_conditions or 'None'}
Medications: {medications or 'None'}
Allergies: {allergies or 'None'}

Food Preferences: {food_preferences or 'None'}
Cooking Ability: {cooking_ability}
Budget: {budget}
Cultural Factors: {cultural_factors or 'None'}

Return:
- Daily calorie guidance
- Meal suggestions
- Simple tips
"""

        result = call_llm(prompt)

    st.success("Your Personalized Plan is Ready!")
    st.markdown(result)
